# Руководство эксплуатации механизма изменения баз данных - миграция

Скрипт миграции - **migrate.sh**, пердставляет собой набор действий 
позволяющих ускорить и упростить процесс подготовки релиза для выноса на 
промышленную базу данных.


## Пакет поставки для миграции
В пакет поставки входят следующие файлы:
* diff_pgdb
* migrate.properties
* migrate.sh
* README.md
* .pgpass

## Установка и настройка окружения

Для работы скрипта миграции, необходимы следующие утилиты:
 * 1. flyway-common (версия используемая на текущий момент 6.1.4)
 * 2. psql 
 * 3. jdk 1.8
 * 4. pg_dump
 * 5. git
 * 6. diff_pgdb

## Где можно взять утилиты:
 * 1. flyway commnity edition можно скачать отсюда - 
[flyway installing](https://flywaydb.org/documentation/commandline)
документация здесь - [flyway documentation](https://flywaydb.org/documentation/migrations)
 * 2. psql / pg_dump- PostgreSQL 10 client [postgresql-client installing](http://postgresguide.com/setup/install.html)
 * 3. jdk 1.8 - [jdk distributive](https://www.oracle.com/java/technologies/javase/javase-jdk8-downloads.html)
 * 4. git -[git downloads](https://git-scm.com/downloads)
 * 5. diff_pgdb - исходный код https://github.com/temudgen/diff_pgdb.git

##  Установка

 (рассматривается только установка в среде linux дистрибутив Ubuntu)

 * **flyway** устанавливается из скаченного архива в любое удобное место
      * создаем символьную ссылку **ln -s <pathFlyway>/flyway /usr/local/bin/flyway**,
      где **pathFlyway** путь до папки с установленной утилитой 
 * **psql** / **pg_dump** устанавливаются из клиета для  СУБД PostgreSQL:
    * **sudo apt-get install postgresql-client** 
    
  * **jdk 1.8** устанавливается для соответствующей архитектуры процессора (x86/x64) и добавляем в путь java в  переменную среды PATH
  * **git** устанавливаем командой
     *  **sudo apt-get install git**
     *  после установки  должен быть  доступен по пути /usr/bin/git
  * **diff_pgdb** идет в комплекте пакета миграции и должен находится в той же папке что и скрипт **migrate.sh**

  
## Настройка
Для работы с скриптом миграции **migrate.sh** необходимо:

* файл **.pgpass** поместить в рабочую папку пользователя - **~/**
    *  файл **.pgpass** нужен для работы утилит psql/pg_dump (чтобы не запрашивал пароли во время выполнения утилит)
    *  формат файла **.pgpass** следующий:
     `<host>:<port>:<dbnme>:<user>:<password>`
* **migrate.properties** - хранит настройки для скрипта миграции - **migrate.sh**
    * источник - бд с котрая является эталонной и являетсяб как правилоб slave db, (свойства имеют префикс **src_** 
          `src_dbname=CIDB`
          `src_port=5432`
          `src_username=postgres`
          `src_host=pgsql-cidb-team-all.dyn.testbanki.ru`
             _ !! Важно отметить, что здесь не указывается пароль к бд источник, тк. скрипт migrate.sh только читает из источника и никогда не меняет источник_
     * цель - бд с которой работаем на разработческом окружении:
          `trg_dbname=CIDB`
          `trg_dbdefault=postgres`
          `trg_port=5434`
          `trg_username=dwh-admin`
          `trg_host=DCK1-Preprod-DWH.devbanki.ru`
          `trg_password=gerparol`
             _Здесь уже указываем пароль бд, т.к. будем менять вплоть до удаления бд_  
     * указываем полного пути или отностильного  для размещения генерируемые скриптом **migrate.sh** скриптов и и временных файлов 
          `sqldir=.sql`
          `tmpdir=.tmp`
     * свойства для работы с утилитой **diff_pgdb**
          `diff_pgdb_arg_exclude_tables=--exclude-tables`
          `diff_pgdb_exclude_tables=flyway_schema_history`
          `diff_pgdb_create_file_storage_functions=--create-storage-functions-only`
          `diff_pgdb_default_path_storage=./db`
          
     * свойства для работы **flyway**
          `flyway_default_artifact_name=CR`
          `flyway_ext=.sql`   

* формат вызова утилиты **flyway**:
	      `flyway -baselineOnMigrate=true -url=jdbc:postgresql://$trg_host:$trg_port/$trg_dbname -user=$trg_username -password=$trg_password -locations=filesystem:"$sqldir" -outputFile="$tmpdir"/flyway.log migrate 2> "$errorlog`   
         в вызове видно, что используются переменные описанные в файле **migrate.properties**    
        **Важно! flyway для корректной работы необходима для подключений уже созданная БД**  
   
  
## Как пользоваться скриптом migrate.sh
####    Краткое описание формата вызова
       migrate.sh [COMMAND] [OPTION] [ARGUMENTS]

#### Описание параметров вызова
   * **init** - снять дамп исходной базы данных и сохранить в локальный файл
   * **init db-use** - вытащить дамп исходной базы данных в локальный файл, затем удалить целевую базу данных, затем применить дамп к целевой базе данных
   * **migrate** - создайте скрипт изменений на основе дампа снятым команодой **init** и внесенных изменениях в файл $tmpdir/changed.sql
   * **migrate db-use** - создать сценарий изменения на основе различий исходного и целевого БД
   * **migrate path_file** - попытаться применить скрипт изменений к целевой бд
   * **git last-hash** - получить последний короткий хэш из git-репо
   * **git comment-by-last-hash** - получить последний комментарий по последнему хешу из git repo
   * **git comment-by-hash c4d2635e67c41j77c23787bdc934e3e03c642d8c** - получить комментарий по хешу из git repo

#### Дополнительное описание команд вызовов - что происходит под "капотом"
   * **init** - по реквизитам указанным в файле .pgpass берутся параметры с прекфиксом src_, снимаем дамп при помощи утилиты `pg_dump`, результат сохраняем в файле $tmpdir/changed.sql и $sql/init.sql   
   Важно! При выполнении команды, все временные папки ($sqldir/$tmpdir) и файлы будут удалены!
  
  * **init db-use** - выполняет тоже самое, что и команда **init**, и пытаемся установить снятый дамп, с ихожной бд, на целевую бд, для этого срубаем все подключения в целевой бд - если с таким именем уже есть бд, 
  то удаляем бд, затем накатываем новый дамп.   
    Т.о.  данная команда позволит разработчику  перенести с исходной бд (slave db) метаданные на разработческий стенд и длаее уже посредствам DBBeaver сам разработчик вносит требуемые изменения.
  **При выполнении данной команды, автоматически будет создано файловое хранилище для всех функций с целевой бд**
  **При выполнении данной команды, проверяйте файл $tmpdir/error.log**   
   Важно! При выполнении команды, все временные папки ($sqldir/$tmpdir) и файлы будут удалены!   
   
   * **migrate** - ожидаем, что были внесены изменения в файл $tmpdir/changed.sql  (который появляется  после выполнения команды **init**), затем  снимаем дамп с исходной бд (slave db), сравниваем дамп исходной бд с файлом  $tmpdir/changed.sql - который был вручную разработчиком изменен, затем, посредствам утилиты **diff_pgdb** (команда выглядит следующим образом:
   **java -jar diff_pgdb --ignore-start-with --drop-if-exists $dump_init_file $path_changed_sql  $diff_file 2> $errorlog**   
   в результате работы утилиты, получаем файл и помещаем его в папку $sqldir (см файл **migrate.properties**)   
   
   *  **migrate db-use** -  выпоняет ряд действий (после внесения изменений в структуру целевой бд разработчиком):   
    снять дамп с исходной бд, затем снять дамб целевой-измененной бд и сравнить посредствам утилиты    **diff_pgdb**, т.о. будет сгенерен скрипт изменений-артифакт в папке $sqldir
  **При выполнении данной команды, автоматически будет создано файловое хранилище для всех функций с целевой бд**
  **При выполнении данной команды, проверяйте файл $tmpdir/error.log**   
   
   *  **migrate path_file** - позволит накатить артифакт на целевую бд посредствам **flyway**. Имя файла формируется следующим образом: из таблицы flyway_schema_history целевой бд берем крайний номер версии и инкрементируем его, т.о. имя файла будет содержать очередную версию скрипта изменения вида Vn__`<hash>`, где n номер очередной версии измененийю, а `<hash>` -  хэш последнего коммита в гите. 
   **Т.о. данную команду нужно использовать для раскатки на целвую бд автоматом,после валиджации скрипта-артифакта администратором целевой бд.**
   **flyway** попытаестя накатить изменения в рамках одной транзакции, в случае ошибки, при выполнении скрипта, транзакция откатится и уже внесенные изменения не применятся на целевой бд
      
### Сценарий для разработкчика с редактированием бд посредствам DBeaver
   - **migrate.sh init force** - поднимает дамп с исходной бд на целевой бд
   - **migrate db-use** - получаем скрипт изменений в папке `$sqldir/CR.sql`
   - проверям, что скрипт изменений корректен
   - помещаем скрипт в папку `<локальная ветка гита>/db/flyway/CR.sql` 
    
### Сценарий для атоматической раскатки бд посредствам Bamboo
   -  **migrate ./db/flyway/CR.sql**
   - после успешного наката изменений, в таблице `select * from flyway_schema_history` должна появиться новая запись с очередной версией изменений и в поле `description` отобразиться хэш последнего коммита  
